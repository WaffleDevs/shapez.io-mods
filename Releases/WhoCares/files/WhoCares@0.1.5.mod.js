/**!
 * Name: WhoCares
 * Description: Bypasses most issues when loading a savegame.
 * Version: 0.1.5
 * Author(s): WaffleDevs
 */
var m=function(exports,game_state,logging,belt,mod,savegame_serializer,serializer_internal,ingame,main_menu,explained_result,global_registries,mod_signals,vector,building_codes,belt_path,modloader,translations,utils,shape_definition,config,loader,item_processor,camera,game_time){"use strict";var img="data:image/webp;base64,UklGRnwAAABXRUJQVlA4IHAAAACwBgCdASpAAEAAPpE4mEeloyKhMB34ALASCUEOADIwaF+AfgBsWPAPwA/IDkAuwGZ+BNN/Dd+rRCSbDaA1AAD+w023w0Q7AxYRwKyXn/mSF12/HimRqnL2gsoGdeXasGNsWtg3etTVAjAPuGE2YAAA";const c={"0.1.5":["Started Work on mod specific fixed. Added failsafe for CCT and possibly fixed Wrexcavator errors.","Added dialog disabling forceload when there are mod differences.","Added button to forceload without failing save first.","Set mod's warning buttons to timeout."],"0.1.0":["Combined Save My Save code into Who Cares","Added information dialog about Save My Save","Added missing and corrupt building removal","Added dialog for confirming forceloading","Fixed missing mod screen bug that errors on loading save"]},metadata={name:"WhoCares",description:"Bypasses most issues when loading a savegame.",version:"0.1.5",settings:{savedEntities:{},seenSmSNotice:!1,latestChangelogSeen:""},extra:{authors:[{name:"WaffleDevs",email:"",website:"https://skimnerphi.net/waffledevs",icon:"https://avatars.githubusercontent.com/u/77215539?s=64"}],updateURL:"https://skimnerphi.net/api/v1/latest/WhoCares"},id:"WhoCares",author:"WaffleDevs",doesNotAffectSavegame:!0,website:"https://skimnerphi.net/mods/WhoCares"};metadata.extra.changelog=c,metadata.extra.icon=img;const logger$3=logging.createLogger("forceload/savser"),SavegameSerializerExt=({$super:e,$old:t})=>({generateDumpFromGameRoot(e,t=!0){const a={camera:e.camera.serialize(),time:e.time.serialize(),map:e.map.serialize(),gameMode:e.gameMode.serialize(),entityMgr:e.entityMgr.serialize(),hubGoals:e.hubGoals.serialize(),entities:this.internal.serializeEntityArray(e.entityMgr.entities),beltPaths:e.systemMgr.systems.belt.serializePaths(),pinnedShapes:e.hud.parts.pinnedShapes?e.hud.parts.pinnedShapes.serialize():null,waypoints:e.hud.parts.waypoints?e.hud.parts.waypoints.serialize():null,modExtraData:{}};return mod_signals.MOD_SIGNALS.gameSerialized.dispatch(e,a),a},verifyLogicalErrors(e,t){if(!t.entities)return explained_result.ExplainedResult.bad("Savegame has no entities");const a=WhoCares.prototype.forceLoad,o=new Set;for(let s=0;s<t.entities.length;++s){const i=t.entities[s],n=i.uid;if(!Number.isInteger(n))return explained_result.ExplainedResult.bad("Entity has invalid uid: "+n);if(o.has(n)){if(!a)return explained_result.ExplainedResult.bad("Duplicate uid "+n);logger$3.log(`Forceloading past "Duplicate uid ${n}"`),e.savegame.getCurrentDump().entities.splice(e.savegame.getCurrentDump().entities.indexOf(i))}if(o.add(n),!i.components)return explained_result.ExplainedResult.bad("Entity is missing key 'components': "+JSON.stringify(i));const r=i.components;for(const e in r){const t=global_registries.gComponentRegistry.findById(e);if(!t){if(a){logger$3.log(`Forceloading past "Unknown component id: ${e}"`);continue}return explained_result.ExplainedResult.bad("Unknown component id: "+e)}const o=r[e],s=t.verify(o);if(s)return explained_result.ExplainedResult.bad("Component "+e+" has invalid data: "+s)}}return explained_result.ExplainedResult.good()},deserialize(e,t){WhoCares.prototype.removedEntityUids=[];const a=this.verifyLogicalErrors(t,e);if(!a.result)return explained_result.ExplainedResult.bad(a.reason);let o=null;o=o||t.entityMgr.deserialize(e.entityMgr);try{if("string"==typeof t.time.deserialize(e.time)&&WhoCares.prototype.forceLoad){const{timeSeconds:a,realtimeSeconds:o,speed:s}=new game_time.GameTime(t);e.time.timeSeconds=a,e.time.realtimeSeconds=o,e.time.speed={$:s.getId(),data:{}}}}catch(e){}o=o||t.time.deserialize(e.time);try{"string"==typeof t.camera.deserialize(e.camera)&&WhoCares.prototype.forceLoad&&(e.camera.prototype=new camera.Camera(t))}catch(e){}return o=o||t.camera.deserialize(e.camera),o=o||t.map.deserialize(e.map),o=o||t.gameMode.deserialize(e.gameMode),o=o||t.hubGoals.deserialize(e.hubGoals,t),o=o||this.internal.deserializeEntityArray(t,e.entities),o=o||t.systemMgr.systems.belt.deserializePaths(e.beltPaths),t.hud.parts.pinnedShapes&&(o=o||t.hud.parts.pinnedShapes.deserialize(e.pinnedShapes)),t.hud.parts.waypoints&&(o=o||t.hud.parts.waypoints.deserialize(e.waypoints)),o?explained_result.ExplainedResult.bad(o):(mod_signals.MOD_SIGNALS.gameDeserialized.dispatch(t,e),explained_result.ExplainedResult.good())}}),functions={};function registerModFix(e,t,a){functions[e]={func:t,when:a}}function runPossibleFixed(e){let t={},a=[];for(const o in functions){const{func:s,when:i}=functions[o];e==i&&(t[o]=s,a.push(o))}return[t,a]}logging.createLogger("forceload/serint");const SerializerInternalExt=({$super:$super,$old:$old})=>({serializeEntityArray(e){const t=[];for(let a=0;a<e.length;++a){const o=e[a];o.queuedForDestroy||o.destroyed||t.push(o.serialize())}return t},deserializeEntityArray(e,t){for(let a=0;a<t.length;++a)this.deserializeEntity(e,t[a])},deserializeEntity(root,payload){const staticData=payload.components.StaticMapEntity;assert(staticData,"entity has no static data");let code=staticData.code,data=building_codes.getBuildingDataFromCode(code);if(console.log(`log ${payload.uid}`),null==data){if(WhoCares.prototype.forceLoad)return;throw new Error}const metaBuilding=data.metaInstance,entity=metaBuilding.createEntity({root:root,origin:vector.Vector.fromSerializedObject(staticData.origin),rotation:staticData.rotation,originalRotation:staticData.originalRotation,rotationVariant:data.rotationVariant,variant:data.variant});if(entity.uid=payload.uid,this.deserializeComponents(root,entity,payload.components),WhoCares.prototype.forceLoad){const fixes=runPossibleFixed("preEntityPlaceDeserialize"),preEntityPlaceDeserialize=fixes[0],ids=fixes[1];for(let i=0;i<ids.length;i++)eval(preEntityPlaceDeserialize[ids[i]]+`fix${ids[i]}()`)}root.entityMgr.registerEntity(entity,payload.uid),console.log(entity),root.map.placeStaticEntity(entity)},deserializeComponents(e,t,a){for(const o in a){if(!t.components[o])continue;const s=t.components[o].deserialize(a[o],e);if(s)return s}}}),logger$2=logging.createLogger("forceload/desSerPath");function deserializePathsRep(e,[t]){if(console.log(WhoCares.prototype.forceLoad+" BELT DESER"),WhoCares.prototype.forceLoad){if(!Array.isArray(t))return"Belt paths are not an array: "+typeof t;for(let e=0;e<t.length;++e){for(let e=0;e<WhoCares.prototype.removedEntityUids.length;++e)console.log(WhoCares.prototype.removedEntityUids[e]),console.log(t[e].entityPath),t[e].entityPath.includes(WhoCares.prototype.removedEntityUids[e])&&console.log(t[e]);const a=belt_path.BeltPath.fromSerialized(this.root,t[e]);if(!(a instanceof belt_path.BeltPath))return"Failed to create path from belt data: "+a;this.beltPaths.push(a)}0===this.beltPaths.length?(logger$2.warn("Recomputing belt paths (most likely the savegame is old or empty)"),this.recomputeAllBeltPaths()):logger$2.warn("Restored",this.beltPaths.length,"belt paths")}else e(t)}function checkForModDifferencesRep(e,[t]){const a=modloader.MODS.computeModDifference(t.currentData.mods);if(0===a.missing.length&&0===a.extra.length)return WhoCares.prototype.hasAllMods=!0,Promise.resolve();WhoCares.prototype.hasAllMods=!1,console.log("Debug - file: MainMenuState.checkForModDifferences.ts:10 - checkForModDifferencesRep - hasAllMods:",WhoCares.prototype.hasAllMods);let o=translations.T.dialogs.modsDifference.desc;function s(e){return`\n                <div class="dialogModsMod">\n                    <div class="name">${e.name}</div>\n                    <div class="version">${translations.T.mods.version} ${e.version}</div>\n                    ${null!=e.website?`<button class="website styledButton" onclick="window.open('${e.website.replace(/"'/,"")}')">${translations.T.mods.modWebsite}</button>`:'<button class="website styledButton">No Website</button>'}\n\n                </div>\n            `}a.missing.length>0&&(o+="<h3>"+translations.T.dialogs.modsDifference.missingMods+"</h3>",o+=a.missing.map(s).join("<br>")),a.extra.length>0&&(o+="<h3>"+translations.T.dialogs.modsDifference.newMods+"</h3>",o+=a.extra.map(s).join("<br>"));const i=this.dialogs.showWarning(translations.T.dialogs.modsDifference.title,o,["cancel:good","continue:bad"]);return new Promise((e=>{i.continue.add(e)}))}function renderSavegamesRep(e,[]){const t=this.htmlElement.querySelector(".mainContainer .savegames");t&&t.remove();const a=this.savedGames;if(a.length>0){const e=utils.makeDiv(this.htmlElement.querySelector(".mainContainer .savegamesMount"),null,["savegames"]);for(let t=0;t<a.length;++t){const o=utils.makeDiv(e,null,["savegame"]);utils.makeDiv(o,null,["playtime"],utils.formatSecondsToTimeAgo(((new Date).getTime()-a[t].lastUpdate)/1e3)),utils.makeDiv(o,null,["level"],a[t].level?translations.T.mainMenu.savegameLevel.replace("<x>",""+a[t].level):translations.T.mainMenu.savegameLevelUnknown),utils.makeDiv(o,null,["name"],"<span>"+(a[t].name?a[t].name:translations.T.mainMenu.savegameUnnamed)+"</span>");const s=document.createElement("button");s.classList.add("styledButton","deleteGame"),s.setAttribute("aria-label","Delete"),o.appendChild(s);const i=document.createElement("button");i.classList.add("styledButton","downloadGame"),i.setAttribute("aria-label","Download"),o.appendChild(i);const n=document.createElement("button");n.classList.add("styledButton","resumeGame"),n.setAttribute("aria-label","Resumee"),o.appendChild(n);const r=document.createElement("button");r.classList.add("styledButton","forceLoad"),r.setAttribute("aria-label","ForceLoad"),r.textContent="F",o.appendChild(r),this.trackClicks(s,(()=>this.deleteGame(a[t]))),this.trackClicks(i,(()=>this.downloadGame(a[t]))),this.trackClicks(n,(()=>this.resumeGame(a[t]))),this.trackClicks(r,(()=>{const{forceload:e}=this.dialogs.showWarning("Force Load?","Savegame failed to load. Forceloading may remove any errors and load anyway. This will destroy any data that is invalid. Create a backup before clicking continue.",["cancel:good","forceload:bad:timeout"]);e.add((()=>{WhoCares.prototype.forceLoad=!0,this.resumeGame(a[t])}))}))}}else utils.makeDiv(this.htmlElement.querySelector(".mainContainer .savegamesMount"),null,["savegamesNone"],translations.T.mainMenu.noActiveSavegames)}const logger$1=logging.createLogger("forceload/oneEnter");function onEnterPost(e){if(e.loadError)if(this.dialogs.close(),WhoCares.prototype.forceLoad){const{ok:e}=this.dialogs.showWarning("Failed","WhoCares was unable to forceload your savegame. Please DM 'WaffleDevs' on discord and send them the save game for additional help.",["ok:good:timeout"]);e.add((()=>{WhoCares.prototype.forceLoad=!1}))}else if(WhoCares.prototype.hasAllMods){const{forceload:e}=this.dialogs.showWarning("Force Load?","Savegame failed to load. Forceloading may remove any errors and load anyway. This will destroy any data that is invalid. Create a backup before clicking continue.",["cancel:good","forceload:bad:timeout"]);e.add((()=>{const e=WhoCares.prototype.latestSavegame;if(null!=e.hubGoals)for(const t of Object.keys(e.hubGoals.storedShapes))try{shape_definition.ShapeDefinition.fromShortKey(t)}catch(a){logger$1.log(`Forceloader removing errored shape ${t}.`),delete e.hubGoals.storedShapes[t]}WhoCares.prototype.forceLoad=!0,this.moveToState("InGameState",{savegame:e})}))}else{const{next:e}=this.dialogs.showWarning("Missing Mods","WhoCares refuses to attempt to fix any savegames that are missing mods. Please install the mods that show on the next menu before continuing.",["next:good"]);e.add((()=>{this.dialogs.close(),this.checkForModDifferences(WhoCares.prototype.latestSavegame)}))}}function moveToStatePre(e,t,a){try{console.log(t.savegame)}catch(e){}"InGameState"==e&&null!=t&&null!=t.savegame&&(WhoCares.prototype.latestSavegame=t.savegame)}function fixCCT(){entity.components.CommandController&&!entity.components.CommandController.command.startsWith("return;")&&(entity.components.CommandController.command=`return;\n${entity.components.CommandController.command}`)}const style=".forceLoad {\n  grid-column: 3/4;\n  grid-row: 1/2;\n  background-color: transparent;\n  background-size: 80%;\n  align-self: start;\n  border-radius: 0;\n  opacity: 0.4;\n  top: -5px;\n  right: 25px;\n}\n.forceLoad:hover {\n  opacity: 0.5;\n}";function fixWrexcavator(){const e=global_registries.gItemRegistry.getById("wreck"),t=global_registries.gItemRegistry.entries.indexOf(e);e.drawItemCenteredClipped=(e,t,a,o=config.globalConfig.defaultItemDiameter)=>{const s=.6*o;this.cachedSprite||(this.cachedSprite=loader.Loader.getSprite("sprites/wreck/shovel.png")),this.cachedSprite.drawCachedCentered(a,e,t,s)},global_registries.gItemRegistry.entries[t]=e}const index="<h1>WhoCares</h1><h2>Latest: 0.1.5</h2><p>WaffleDevs</p><p>Does whatever it can to load your save. However, it has the chance to break it further, so always backup your save before force loading.</p>",logger=logging.createLogger("forceload/startCharge");function startNewChargeRep(e,[t]){try{const e=t.components.ItemProcessor,a=e.inputSlots,o=[],s=this.handlers[e.type];assert(s,"No handler for processor type defined: "+e.type),s({entity:t,items:a,outItems:o,inputCount:e.inputCount});for(let e=0;e<o.length;++e)o[e].doNotTrack||this.root.signals.itemProduced.dispatch(o[e].item);const i=1/this.root.hubGoals.getProcessorBaseSpeed(e.type),n=Math.min(i,e.bonusTime),r=i-n;e.bonusTime-=n,e.ongoingCharges.push({items:o,remainingTime:r}),e.inputSlots.clear(),e.inputCount=0}catch(e){logger.log("Forceloading past startNewCharge error.")}}logging.createLogger("forceload/core");const forceLoadExeptionLogger=logging.createLogger("forceload/error");class WhoCares extends mod.Mod{constructor(){super(...arguments),this.forceLoad=!1,this.hasAllMods=!1,this.removedEntityUids=[],this.WhoCaresSavegameData={savedEntities:{}}}init(){this.metadata.extra.readme=index,this.modInterface.registerTranslations("en",{dialogs:{buttons:{forceload:"ForceLoad",next:"Next"}}}),this.modInterface.runBeforeMethod(game_state.GameState,"moveToState",moveToStatePre),this.modInterface.runAfterMethod(main_menu.MainMenuState,"onEnter",onEnterPost),this.modInterface.extendClass(savegame_serializer.SavegameSerializer,SavegameSerializerExt),this.modInterface.extendClass(serializer_internal.SerializerInternal,SerializerInternalExt),this.modInterface.replaceMethod(belt.BeltSystem,"deserializePaths",deserializePathsRep),this.modInterface.replaceMethod(item_processor.ItemProcessorSystem,"startNewCharge",startNewChargeRep),this.modInterface.replaceMethod(main_menu.MainMenuState,"checkForModDifferences",checkForModDifferencesRep),this.modInterface.replaceMethod(main_menu.MainMenuState,"renderSavegames",renderSavegamesRep),registerModFix("CCT",fixCCT,"preEntityPlaceDeserialize"),registerModFix("Wrexcavator",fixWrexcavator,"MainMenuState"),this.signals.stateEntered.add((state=>{if(state instanceof main_menu.MainMenuState&&(this.settings.seenSmSNotice||(this.dialogs.showInfo("Notice:",'With the Authors permission, Who Cares now bundles a mod called "Save my Save" by StealthC within. If you would like to visit the webpage for Save my Save, click <a onclick="window.open(\'https://mod.io/g/shapez/m/save-my-save\')">here</a>.',["ok:good"]),this.settings.seenSmSNotice=!0,this.saveSettings()),this.forceLoad)){const fixes=runPossibleFixed("MainMenuState"),preEntityPlaceDeserialize=fixes[0],ids=fixes[1];for(let i=0;i<ids.length;i++)eval(preEntityPlaceDeserialize[ids[i]]+`fix${ids[i]}()`)}})),this.modInterface.replaceMethod(ingame.InGameState,"saveThenGoToState",((e,[t,a])=>{if(!t)return new SyntaxError;e(t,a)})),this.modInterface.registerCss(style)}}return exports.default=WhoCares,exports.forceLoadExeptionLogger=forceLoadExeptionLogger,exports.m=metadata,exports}({},shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez,shapez);$shapez_registerMod(m.default,m.m);
